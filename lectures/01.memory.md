# Память в С++
### Кеш, оперативная память, стек и куча, выделение и освобождение памяти
---

#### Процессор
![](images/processor.png)

#### Важные константы
```
1 такт = 1 / частота процессора
1 / 3 GHz = 0.3 ns
                                             0.3 ns
L1 cache reference                           0.5 ns
Branch mispredict                            5   ns
```
> Неудачный if ()
```
L2 cache reference                           7   ns
Mutex lock/unlock                           25   ns
Main memory reference                      100   ns
```
> Кроме задержки (latency) есть понятие пропускной способности (throughput, bandwidth). В случае чтения из RAM - 10-50 Gb/sec
```
Compress 1K bytes with Zippy             3,000   ns
Send 1K bytes over 1 Gbps network       10,000   ns
Read 4K randomly from SSD              150,000   ns
Read 1 MB sequentially from memory     250,000   ns
Round trip within same datacenter      500,000   ns
Read 1 MB sequentially from SSD      1,000,000   ns
HDD seek                            10,000,000   ns
Read 1 MB sequentially from HDD     20,000,000   ns
Send packet CA->Netherlands->CA    150,000,000   ns
```
Источник: [https://gist.github.com/jboner/2841832](https://gist.github.com/jboner/2841832)

#### Стек (Stack)
![](images/stack.png)

```c++
int i = 5;
std::string name;
char data[5];
```

#### Куча (Heap)
```c++
int* i = (int*) malloc(sizeof(int));
std::string* name = new std::string();
char* data = new char[5];
...
free(i);
delete(name);
delete[] data;
```

#### Data segment
```c++
static const int i = 5;
static std::string name;
extern char data[5];
```

#### Адресная арифметика
sizeof - размер типа в байтах
> C++ не дает гарантий на точный размер int, long и т.д. В кроссплатформенном коде надо использовать int32_t, uint64_t и т.д.
```c++
int* i = ...;
++i;
```
Фактически:
```c++
ptr = (char*) i;
ptr = ptr + sizeof(int);
i = (int*) ptr;
```
```c++
i += 5;
```
Фактически:
```c++
ptr = (char*) i;
ptr = ptr + 5 * sizeof(int);
i = (int*) ptr;
```
> C-cast использовать в С++ нельзя! Как надо приводить типы в С++ и надо ли вообще будет в другой лекции














